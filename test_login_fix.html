<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录修复测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #loginForm {
            margin: 20px 0;
        }
        input {
            margin: 5px;
            padding: 8px;
        }
    </style>
</head>
<body>
    <h1>登录功能修复测试</h1>

    <!-- 测试模块1：初始化用户管理 -->
    <div class="test-section">
        <h2>1. 初始化用户管理</h2>
        <button id="initUserManagement">初始化用户管理模块</button>
        <div id="initResult" class="result"></div>
    </div>

    <!-- 测试模块2：登录表单 -->
    <div class="test-section">
        <h2>2. 登录测试</h2>
        <form id="loginForm">
            <input type="text" id="loginUsername" placeholder="用户名" value="zhenglin">
            <input type="password" id="loginPassword" placeholder="密码" value="134625">
            <button type="submit">登录</button>
        </form>
        <div id="loginResult" class="result"></div>
    </div>

    <!-- 测试模块3：用户状态检查 -->
    <div class="test-section">
        <h2>3. 用户状态检查</h2>
        <button id="checkUserStatus">检查当前用户状态</button>
        <div id="statusResult" class="result"></div>
    </div>

    <!-- 测试模块4：界面状态检查 -->
    <div class="test-section">
        <h2>4. 界面状态检查</h2>
        <button id="checkInterface">检查界面元素状态</button>
        <div id="interfaceResult" class="result"></div>
    </div>

    <!-- 测试模块5：登录后等待检查 -->
    <div class="test-section">
        <h2>5. 登录后等待检查</h2>
        <button id="waitAndCheck">登录后等待2秒检查</button>
        <div id="waitResult" class="result"></div>
    </div>

    <!-- 模拟的界面元素 -->
    <div id="userActions" style="display: block;">
        <button onclick="openModal('loginModal')">登录</button>
        <button onclick="openModal('registerModal')">注册</button>
    </div>
    <div id="userProfile" style="display: none;">
        <span id="currentUsername">未登录</span>
        <button onclick="logout()">退出登录</button>
    </div>
    
    <div id="loginUsernameError" style="color: red;"></div>

    <!-- 引入必要的JavaScript文件 -->
    <script src="js/Supabase.js"></script>
    <script src="js/ModalSystem.js"></script>
    <script src="js/modules/UserManagement.js"></script>

    <!-- 测试脚本 -->
    <script>
        // 模拟关闭模态框函数
        function closeModal(modalId) {
            console.log('关闭模态框:', modalId);
        }

        // 模拟打开模态框函数
        function openModal(modalId) {
            console.log('打开模态框:', modalId);
        }

        // 初始化测试
        document.getElementById('initUserManagement').addEventListener('click', async () => {
            const resultDiv = document.getElementById('initResult');
            
            try {
                // 检查UserManagement是否存在
                if (typeof UserManagement === 'undefined') {
                    resultDiv.innerHTML = '<div class="error">UserManagement未定义</div>';
                    return;
                }

                // 初始化用户管理模块
                await userManagement.initialize();
                resultDiv.innerHTML = '<div class="success">用户管理模块初始化成功</div>';
                
                // 显示当前用户列表
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                resultDiv.innerHTML += '<div class="info">当前用户列表: ' + JSON.stringify(users) + '</div>';
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">初始化失败: ' + error.message + '</div>';
                console.error('初始化错误:', error);
            }
        });

        // 登录测试
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const resultDiv = document.getElementById('loginResult');
            
            try {
                await userManagement.handleLogin(e);
                
                // 检查登录结果
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (currentUser) {
                    resultDiv.innerHTML = '<div class="success">登录成功！当前用户: ' + currentUser.username + ' (' + currentUser.role + ')</div>';
                } else {
                    resultDiv.innerHTML = '<div class="error">登录失败！</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">登录错误: ' + error.message + '</div>';
                console.error('登录错误:', error);
            }
        });

        // 检查用户状态
        document.getElementById('checkUserStatus').addEventListener('click', () => {
            const resultDiv = document.getElementById('statusResult');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            resultDiv.innerHTML = '<div class="info">当前用户: ' + JSON.stringify(currentUser) + '</div>';
            resultDiv.innerHTML += '<div class="info">用户列表: ' + JSON.stringify(users) + '</div>';
            resultDiv.innerHTML += '<div class="info">UserManagement.currentUser: ' + JSON.stringify(userManagement.currentUser) + '</div>';
        });

        // 检查界面状态
        document.getElementById('checkInterface').addEventListener('click', () => {
            const resultDiv = document.getElementById('interfaceResult');
            
            const userActions = document.getElementById('userActions');
            const userProfile = document.getElementById('userProfile');
            const currentUsername = document.getElementById('currentUsername');
            
            resultDiv.innerHTML = '<div class="info">userActions显示状态: ' + (userActions.style.display === 'block' ? '显示' : '隐藏') + '</div>';
            resultDiv.innerHTML += '<div class="info">userProfile显示状态: ' + (userProfile.style.display === 'block' ? '显示' : '隐藏') + '</div>';
            resultDiv.innerHTML += '<div class="info">当前用户名显示: ' + currentUsername.textContent + '</div>';
        });

        // 登录后等待检查
        document.getElementById('waitAndCheck').addEventListener('click', async () => {
            const resultDiv = document.getElementById('waitResult');
            
            // 先尝试登录
            try {
                await userManagement.handleLogin(new Event('submit'));
            } catch (error) {
                console.error('登录错误:', error);
            }
            
            // 等待2秒后检查
            resultDiv.innerHTML = '<div class="info">等待2秒后检查...</div>';
            
            setTimeout(() => {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                const userProfile = document.getElementById('userProfile');
                
                if (currentUser && userProfile.style.display === 'block') {
                    resultDiv.innerHTML += '<div class="success">登录状态保持良好！</div>';
                } else {
                    resultDiv.innerHTML += '<div class="error">登录状态丢失或界面未更新！</div>';
                }
                
                resultDiv.innerHTML += '<div class="info">当前用户: ' + JSON.stringify(currentUser) + '</div>';
                resultDiv.innerHTML += '<div class="info">userProfile状态: ' + userProfile.style.display + '</div>';
            }, 2000);
        });

        // 页面加载完成后自动初始化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await userManagement.initialize();
                console.log('页面加载完成，用户管理模块已初始化');
            } catch (error) {
                console.error('自动初始化错误:', error);
            }
        });
    </script>
</body>
</html>
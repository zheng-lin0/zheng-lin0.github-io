<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具功能调试</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .debug-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .debug-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .tool-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .tool-btn {
            padding: 12px 20px;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .tool-btn:hover {
            background: #4f46e5;
        }
        
        .log-panel {
            max-height: 400px;
            overflow-y: auto;
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 2px 0;
            border-bottom: 1px solid #4a5568;
        }
        
        .log-error {
            color: #f56565;
        }
        
        .log-success {
            color: #48bb78;
        }
        
        .log-info {
            color: #4299e1;
        }
        
        .tool-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #ebf8ff;
            color: #2c5282;
        }
    </style>
</head>
<body>
    <h1>工具功能调试面板</h1>
    <p>此页面用于详细调试工具功能，包含完整的调用流程日志和状态信息。</p>
    
    <div class="tool-buttons">
        <button class="tool-btn" onclick="testTool('text-to-speech')">
            <i class="fas fa-comment-dots"></i> 文字转语音
        </button>
        <button class="tool-btn" onclick="testTool('calculator')">
            <i class="fas fa-calculator"></i> 计算器
        </button>
        <button class="tool-btn" onclick="testTool('unit-converter')">
            <i class="fas fa-exchange-alt"></i> 单位转换
        </button>
        <button class="tool-btn" onclick="testTool('password-generator')">
            <i class="fas fa-key"></i> 密码生成器
        </button>
        <button class="tool-btn" onclick="testTool('age-calculator')">
            <i class="fas fa-birthday-cake"></i> 年龄计算器
        </button>
        <button class="tool-btn" onclick="testCloseTool()" style="background: #718096;">
            <i class="fas fa-times"></i> 关闭工具
        </button>
        <button class="tool-btn" onclick="clearLogs()" style="background: #e53e3e;">
            <i class="fas fa-trash"></i> 清除日志
        </button>
    </div>
    
    <div class="debug-container">
        <div class="debug-panel">
            <h3>调用流程日志</h3>
            <div class="log-panel" id="log-panel"></div>
        </div>
        
        <div class="debug-panel">
            <h3>工具状态信息</h3>
            <div id="tool-status"></div>
            
            <h3>全局对象检查</h3>
            <div id="global-checks"></div>
        </div>
    </div>
    
    <!-- 工具组件脚本 -->
    <script src="js/components/TextToSpeech.js"></script>
    <script src="js/components/Calculator.js"></script>
    <script src="js/components/UnitConverter.js"></script>
    <script src="js/components/PasswordGenerator.js"></script>
    <script src="js/components/AgeCalculator.js"></script>
    
    <!-- 工具管理器模块 -->
    <script src="js/modules/ToolManager.js"></script>
    
    <script>
        // 重写console.log以同时输出到日志面板
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            addLogEntry(args.join(' '), 'info');
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            addLogEntry(args.join(' '), 'error');
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addLogEntry(args.join(' '), 'warn');
            originalWarn.apply(console, args);
        };
        
        // 添加日志条目
        function addLogEntry(message, type = 'info') {
            const panel = document.getElementById('log-panel');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span style="color: #a0aec0;">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            panel.appendChild(entry);
            panel.scrollTop = panel.scrollHeight;
        }
        
        // 清除日志
        function clearLogs() {
            document.getElementById('log-panel').innerHTML = '';
            addLogEntry('日志已清除');
        }
        
        // 测试工具
        function testTool(toolId) {
            addLogEntry(`=== 开始测试工具: ${toolId} ===`);
            
            // 检查工具管理器是否存在
            if (typeof toolManager === 'undefined') {
                addLogEntry('错误: toolManager未定义', 'error');
                return;
            }
            
            // 检查工具是否存在
            const tool = toolManager.getToolById(toolId);
            if (!tool) {
                addLogEntry(`错误: 工具 ${toolId} 未找到`, 'error');
                return;
            }
            
            addLogEntry(`工具信息: ${JSON.stringify(tool)}`);
            
            // 检查工具组件是否已加载
            const componentName = toolId.replace(/-/g, '');
            const windowComponentName = `window.${componentName}`;
            addLogEntry(`检查组件: ${windowComponentName}`);
            
            try {
                // 调用工具管理器的openTool方法
                addLogEntry('调用 toolManager.openTool()');
                toolManager.openTool(toolId);
                addLogEntry('toolManager.openTool() 调用成功', 'success');
                
                // 检查模态框是否创建
                setTimeout(() => {
                    const modal = document.getElementById('toolComponentModal');
                    if (modal) {
                        addLogEntry('模态框已成功创建', 'success');
                        addLogEntry(`模态框状态: 显示=${modal.classList.contains('show')}`);
                    } else {
                        addLogEntry('错误: 模态框未创建', 'error');
                    }
                }, 500);
                
            } catch (error) {
                addLogEntry(`错误: ${error.message}`, 'error');
                addLogEntry(`错误堆栈: ${error.stack}`, 'error');
            }
        }
        
        // 测试关闭工具
        function testCloseTool() {
            addLogEntry('=== 测试关闭工具 ===');
            
            try {
                if (typeof closeToolComponent === 'function') {
                    closeToolComponent();
                    addLogEntry('closeToolComponent() 调用成功', 'success');
                    
                    // 检查模态框是否移除
                    setTimeout(() => {
                        const modal = document.getElementById('toolComponentModal');
                        if (!modal) {
                            addLogEntry('模态框已成功移除', 'success');
                        } else {
                            addLogEntry('警告: 模态框仍存在', 'warn');
                        }
                    }, 100);
                } else {
                    addLogEntry('错误: closeToolComponent未定义', 'error');
                }
            } catch (error) {
                addLogEntry(`错误: ${error.message}`, 'error');
            }
        }
        
        // 检查全局对象
        function checkGlobalObjects() {
            addLogEntry('=== 检查全局对象 ===');
            
            const checks = document.getElementById('global-checks');
            checks.innerHTML = '';
            
            const objectsToCheck = [
                'toolManager',
                'TextToSpeech',
                'Calculator',
                'UnitConverter',
                'PasswordGenerator',
                'AgeCalculator',
                'textToSpeech',
                'calculator',
                'unitConverter',
                'passwordGenerator',
                'ageCalculator',
                'closeToolComponent'
            ];
            
            objectsToCheck.forEach(objName => {
                const exists = typeof window[objName] !== 'undefined';
                const status = exists ? '<span style="color: #48bb78;">✓</span>' : '<span style="color: #f56565;">✗</span>';
                const type = exists ? typeof window[objName] : 'undefined';
                
                const div = document.createElement('div');
                div.innerHTML = `${status} ${objName}: ${type}`;
                checks.appendChild(div);
            });
            
            addLogEntry('全局对象检查完成');
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('调试页面加载完成', 'success');
            addLogEntry('工具组件脚本已加载');
            
            // 检查全局对象
            checkGlobalObjects();
            
            // 检查工具列表
            if (typeof toolManager !== 'undefined') {
                const tools = toolManager.getTools();
                addLogEntry(`工具管理器已初始化，包含 ${tools.length} 个工具`);
                
                tools.forEach(tool => {
                    addLogEntry(`工具: ${tool.id} - ${tool.name}`);
                });
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯Šæ–­é—®é¢˜</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background-color: #f8f9fa;
            padding: 10px;
            margin-top: 10px;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .btn {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>è¯Šæ–­æœªç™»å½•æ—¶æ˜¾ç¤ºç®¡ç†å‘˜è´¦å·çš„é—®é¢˜</h1>
    
    <div class="test-section">
        <h2>1. æ¸…é™¤æœ¬åœ°å­˜å‚¨</h2>
        <button class="btn" onclick="clearLocalStorage()">æ¸…é™¤localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯</button>
        <div id="clearResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€</h2>
        <button class="btn" onclick="checkCurrentUser()">æ£€æŸ¥å½“å‰ç”¨æˆ·</button>
        <div id="userResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>3. æ£€æŸ¥ç”¨æˆ·èµ„æ–™åŒºåŸŸ</h2>
        <button class="btn" onclick="checkUserProfile()">æ£€æŸ¥userProfileå…ƒç´ </button>
        <div id="profileResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>4. æ‰‹åŠ¨æ›´æ–°ç”¨æˆ·ç•Œé¢</h2>
        <button class="btn" onclick="updateUI()">è°ƒç”¨updateUserInterface</button>
        <div id="updateResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>5. å®Œæ•´è¯Šæ–­</h2>
        <button class="btn" onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <div id="fullResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>ç”¨æˆ·èµ„æ–™é¢„è§ˆ</h2>
        <div id="userProfilePreview" style="margin-top: 10px;">
            <div class="user-menu" id="userProfile" style="display: none;">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName"></div>
                    <div class="user-level" id="userLevel"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function clearLocalStorage() {
            const resultDiv = document.getElementById('clearResult');
            
            try {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('users');
                localStorage.removeItem('spyCacheBackup');
                
                resultDiv.innerHTML = 'âœ… å·²æ¸…é™¤ä»¥ä¸‹localStorageé¡¹ï¼š<br>';
                resultDiv.innerHTML += '- currentUser<br>';
                resultDiv.innerHTML += '- users<br>';
                resultDiv.innerHTML += '- spyCacheBackup<br>';
                
                // é‡ç½®å½“å‰ç”¨æˆ·
                if (window.userManagement) {
                    window.userManagement.currentUser = null;
                    resultDiv.innerHTML += 'âœ… å·²é‡ç½®userManagement.currentUserä¸ºnull<br>';
                }
                
            } catch (error) {
                resultDiv.innerHTML = 'âŒ æ¸…é™¤localStorageå¤±è´¥ï¼š' + error.message;
            }
        }
        
        function checkCurrentUser() {
            const resultDiv = document.getElementById('userResult');
            
            resultDiv.innerHTML = 'ğŸ” æ£€æŸ¥å½“å‰ç”¨æˆ·çŠ¶æ€...<br>';
            
            if (window.userManagement) {
                resultDiv.innerHTML += 'userManagementå­˜åœ¨: âœ…<br>';
                resultDiv.innerHTML += 'currentUser: ' + JSON.stringify(window.userManagement.currentUser) + '<br>';
                resultDiv.innerHTML += 'isInitialized: ' + window.userManagement.isInitialized + '<br>';
            } else {
                resultDiv.innerHTML += 'userManagementä¸å­˜åœ¨: âŒ<br>';
            }
            
            resultDiv.innerHTML += 'localStorage.currentUser: ' + localStorage.getItem('currentUser') + '<br>';
            resultDiv.innerHTML += 'localStorage.users: ' + localStorage.getItem('users') + '<br>';
        }
        
        function checkUserProfile() {
            const resultDiv = document.getElementById('profileResult');
            const userProfile = document.getElementById('userProfile');
            
            resultDiv.innerHTML = 'ğŸ” æ£€æŸ¥ç”¨æˆ·èµ„æ–™åŒºåŸŸ...<br>';
            
            if (userProfile) {
                resultDiv.innerHTML += 'userProfileå…ƒç´ å­˜åœ¨: âœ…<br>';
                resultDiv.innerHTML += 'displayæ ·å¼: ' + userProfile.style.display + '<br>';
                resultDiv.innerHTML += 'å®Œæ•´æ ·å¼: ' + userProfile.style.cssText + '<br>';
                resultDiv.innerHTML += 'å®é™…æ˜¾ç¤ºçŠ¶æ€: ' + (userProfile.offsetParent !== null ? 'å¯è§' : 'éšè—') + '<br>';
            } else {
                resultDiv.innerHTML += 'userProfileå…ƒç´ ä¸å­˜åœ¨: âŒ<br>';
            }
        }
        
        function updateUI() {
            const resultDiv = document.getElementById('updateResult');
            
            resultDiv.innerHTML = 'ğŸ”„ è°ƒç”¨updateUserInterface...<br>';
            
            if (window.userManagement && window.userManagement.updateUserInterface) {
                try {
                    window.userManagement.updateUserInterface();
                    resultDiv.innerHTML += 'âœ… è°ƒç”¨æˆåŠŸ<br>';
                    
                    // æ£€æŸ¥æ›´æ–°åçš„çŠ¶æ€
                    const userProfile = document.getElementById('userProfile');
                    if (userProfile) {
                        resultDiv.innerHTML += 'æ›´æ–°ådisplayæ ·å¼: ' + userProfile.style.display + '<br>';
                        resultDiv.innerHTML += 'æ›´æ–°åå®é™…æ˜¾ç¤ºçŠ¶æ€: ' + (userProfile.offsetParent !== null ? 'å¯è§' : 'éšè—') + '<br>';
                    }
                } catch (error) {
                    resultDiv.innerHTML += 'âŒ è°ƒç”¨å¤±è´¥: ' + error.message + '<br>';
                }
            } else {
                resultDiv.innerHTML += 'âŒ updateUserInterfaceæ–¹æ³•ä¸å­˜åœ¨<br>';
            }
        }
        
        function runFullDiagnostic() {
            const resultDiv = document.getElementById('fullResult');
            
            resultDiv.innerHTML = 'ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­...<br>';
            
            // 1. æ¸…é™¤æ‰€æœ‰ç”¨æˆ·æ•°æ®
            clearLocalStorage();
            
            // 2. é‡ç½®ç”¨æˆ·ç®¡ç†æ¨¡å—
            if (window.userManagement) {
                window.userManagement.currentUser = null;
            }
            
            // 3. æ£€æŸ¥åˆå§‹çŠ¶æ€
            setTimeout(() => {
                resultDiv.innerHTML += '<br>=== åˆå§‹çŠ¶æ€æ£€æŸ¥ ===<br>';
                resultDiv.innerHTML += 'localStorage.currentUser: ' + localStorage.getItem('currentUser') + '<br>';
                resultDiv.innerHTML += 'userManagement.currentUser: ' + JSON.stringify(window.userManagement?.currentUser) + '<br>';
                
                // 4. æ£€æŸ¥userProfile
                const userProfile = document.getElementById('userProfile');
                if (userProfile) {
                    resultDiv.innerHTML += 'åˆå§‹userProfile.display: ' + userProfile.style.display + '<br>';
                    resultDiv.innerHTML += 'åˆå§‹userProfileå¯è§æ€§: ' + (userProfile.offsetParent !== null ? 'å¯è§' : 'éšè—') + '<br>';
                }
                
                // 5. è°ƒç”¨updateUserInterface
                if (window.userManagement?.updateUserInterface) {
                    try {
                        window.userManagement.updateUserInterface();
                        resultDiv.innerHTML += '<br>=== æ›´æ–°ç•Œé¢å ===<br>';
                        
                        if (userProfile) {
                            resultDiv.innerHTML += 'æ›´æ–°åuserProfile.display: ' + userProfile.style.display + '<br>';
                            resultDiv.innerHTML += 'æ›´æ–°åuserProfileå¯è§æ€§: ' + (userProfile.offsetParent !== null ? 'å¯è§' : 'éšè—') + '<br>';
                        }
                        
                        resultDiv.innerHTML += 'æ›´æ–°åcurrentUser: ' + JSON.stringify(window.userManagement.currentUser) + '<br>';
                        
                    } catch (error) {
                        resultDiv.innerHTML += 'âŒ æ›´æ–°ç•Œé¢å¤±è´¥: ' + error.message + '<br>';
                    }
                }
                
                // 6. æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ä»£ç ä¿®æ”¹currentUser
                resultDiv.innerHTML += '<br>=== æœ€ç»ˆæ£€æŸ¥ ===<br>';
                resultDiv.innerHTML += 'localStorage.currentUser: ' + localStorage.getItem('currentUser') + '<br>';
                resultDiv.innerHTML += 'userManagement.currentUser: ' + JSON.stringify(window.userManagement?.currentUser) + '<br>';
                
            }, 500);
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('è¯Šæ–­é¡µé¢åŠ è½½å®Œæˆ');
            checkCurrentUser();
            checkUserProfile();
        });
    </script>
</body>
</html>